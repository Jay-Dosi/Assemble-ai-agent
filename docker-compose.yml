version: "3.9"
services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"

  backend:
    build:
      context: ./backend
    environment:
      WORKSPACE_ROOT: /workspace
      PROJECT_TEST_CMD: ${PROJECT_TEST_CMD:-npm test -- --runInBand}
      OUMI_API_KEY: ${OUMI_API_KEY}
      OUMI_BASE_URL: ${OUMI_BASE_URL:-http://oumi:8000/v1/chat/completions}
      OUMI_MODEL: ${OUMI_MODEL:-gpt-4o-mini}
      CLINE_ENDPOINT: ${CLINE_ENDPOINT:-http://cline:3005/v1/mission}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      REPO_FULL_NAME: ${REPO_FULL_NAME}
      DASHBOARD_ORIGIN: ${DASHBOARD_ORIGIN:-http://localhost:3000}
      REDIS_URL: redis://redis:6379
      API_TOKEN: ${API_TOKEN:-devtoken123}
      DETECTION_INTERVAL_MS: ${DETECTION_INTERVAL_MS:-900000}
      SANDBOX_IMAGE: ${SANDBOX_IMAGE:-node:20-bookworm}
      SANDBOX_WORKDIR: /workspace
    volumes:
      - ./:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    depends_on:
      - redis
    ports:
      - "4000:4000"

  dashboard:
    build:
      context: ./dashboard
    environment:
      NEXT_PUBLIC_BACKEND_ORIGIN: ${NEXT_PUBLIC_BACKEND_ORIGIN:-http://localhost:4000}
      NEXT_PUBLIC_API_TOKEN: ${API_TOKEN:-devtoken123}
    ports:
      - "3000:3000"
    depends_on:
      - backend

